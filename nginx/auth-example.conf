# Example nginx configuration for API Gatekeeper integration
#
# This configuration demonstrates how to use the API Gatekeeper auth service
# with nginx's auth_request module to protect backend APIs.

# Upstream auth service
upstream auth_service {
    server localhost:7843;
    # For production, consider:
    # - Multiple instances for high availability
    # - Health checks
    # - Connection pooling settings
    keepalive 32;
}

# Upstream backend API (your actual API service)
upstream backend_api {
    server localhost:8000;
    keepalive 32;
}

# Main API server block
server {
    listen 80;
    server_name api.example.com;

    # Logging
    access_log /var/log/nginx/api_access.log combined;
    error_log /var/log/nginx/api_error.log warn;

    # Protected API routes
    location /api/ {
        # Step 1: Perform authentication/authorization check
        auth_request /authz;

        # Step 2: Extract client info from auth response headers
        auth_request_set $auth_client_id $upstream_http_x_auth_client_id;
        auth_request_set $auth_client_name $upstream_http_x_auth_client_name;
        auth_request_set $auth_route_id $upstream_http_x_auth_route_id;

        # Step 3: Pass client info to backend API
        proxy_set_header X-Client-ID $auth_client_id;
        proxy_set_header X-Client-Name $auth_client_name;
        proxy_set_header X-Route-ID $auth_route_id;

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Proxy to backend
        proxy_pass http://backend_api;
    }

    # Internal authorization endpoint (not accessible externally)
    location = /authz {
        # Mark as internal - only accessible via auth_request
        internal;

        # Proxy to auth service
        proxy_pass http://auth_service/authz;

        # Pass original request information to auth service
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;

        # Forward client's Authorization header
        proxy_set_header Authorization $http_authorization;

        # Forward request body for HMAC validation
        proxy_pass_request_body on;
        proxy_set_header Content-Length $content_length;

        # Disable buffering for faster auth responses
        proxy_buffering off;

        # Timeout settings
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Health check endpoint (optional - for monitoring)
    location = /health {
        proxy_pass http://auth_service/health;
        access_log off;
    }

    # Handle auth failures with custom error pages
    error_page 403 /403.json;
    location = /403.json {
        internal;
        default_type application/json;
        return 403 '{"error": "Forbidden", "message": "Access denied"}';
    }
}

# Example: Public routes (no authentication required)
#
# If you have some routes that should be public, you can configure
# them without auth_request:
#
# server {
#     listen 80;
#     server_name api.example.com;
#
#     # Public health endpoint (no auth)
#     location = /api/health {
#         proxy_pass http://backend_api/api/health;
#     }
#
#     # Public docs (no auth)
#     location /api/docs {
#         proxy_pass http://backend_api/api/docs;
#     }
#
#     # Protected endpoints (with auth)
#     location /api/ {
#         auth_request /authz;
#         # ... rest of auth_request config
#         proxy_pass http://backend_api;
#     }
# }

# Example: Multiple backend services with different auth requirements
#
# server {
#     listen 80;
#     server_name api.example.com;
#
#     # Service A - Users API
#     location /api/users/ {
#         auth_request /authz;
#         auth_request_set $auth_client_id $upstream_http_x_auth_client_id;
#         proxy_set_header X-Client-ID $auth_client_id;
#         proxy_pass http://users_service/;
#     }
#
#     # Service B - Orders API
#     location /api/orders/ {
#         auth_request /authz;
#         auth_request_set $auth_client_id $upstream_http_x_auth_client_id;
#         proxy_set_header X-Client-ID $auth_client_id;
#         proxy_pass http://orders_service/;
#     }
#
#     # Shared auth endpoint
#     location = /authz {
#         internal;
#         proxy_pass http://auth_service/authz;
#         proxy_set_header X-Original-URI $request_uri;
#         proxy_set_header X-Original-Method $request_method;
#         proxy_set_header Authorization $http_authorization;
#     }
# }

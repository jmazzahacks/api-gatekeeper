# Example nginx configuration for API Gatekeeper integration
# This shows a complete working setup for protecting a backend API

# Define the API Gatekeeper auth service
upstream auth_service {
    server brutus.mazza.vc:7843;
    # Or for local development:
    # server localhost:7843;
}

# Define your backend API service
upstream backend_api {
    server localhost:8000;
    # Add more backend servers for load balancing if needed
    # server localhost:8001;
    # server localhost:8002;
}

server {
    listen 80;
    server_name api.example.com;

    # Optional: Redirect HTTP to HTTPS
    # return 301 https://$server_name$request_uri;

    # For this example, we'll serve on HTTP
    # In production, use HTTPS with SSL certificates

    # Log files
    access_log /var/log/nginx/api.example.com.access.log;
    error_log /var/log/nginx/api.example.com.error.log;

    # Public endpoint - no authentication required
    location /api/public {
        # No auth_request here - open to everyone

        proxy_pass http://backend_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Protected API endpoints - require authentication
    location /api/ {
        # Call auth service before proxying request
        auth_request /authz;

        # Extract authenticated client info from auth service response
        auth_request_set $auth_client_id $upstream_http_x_auth_client_id;
        auth_request_set $auth_client_name $upstream_http_x_auth_client_name;
        auth_request_set $auth_route_id $upstream_http_x_auth_route_id;

        # Pass client info to backend API
        proxy_set_header X-Client-ID $auth_client_id;
        proxy_set_header X-Client-Name $auth_client_name;
        proxy_set_header X-Route-ID $auth_route_id;

        # Standard proxy headers
        proxy_pass http://backend_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Forward the original Authorization header to backend
        proxy_set_header Authorization $http_authorization;
    }

    # Internal authentication endpoint (not accessible externally)
    location = /authz {
        internal;  # Only accessible from within nginx

        # Call the API Gatekeeper service
        proxy_pass http://auth_service/authz;

        # Pass original request information to auth service
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header X-Original-Host $host;  # Domain-based routing

        # Forward the Authorization header (API key or HMAC)
        proxy_set_header Authorization $http_authorization;

        # Forward query string for API key in query params
        proxy_set_header X-Original-Query $query_string;

        # Don't pass request body to auth service (improves performance)
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";

        # Timeout settings
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Health check endpoint (optional)
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}

# Example: Multiple domains with different auth rules
server {
    listen 80;
    server_name admin.example.com;

    access_log /var/log/nginx/admin.example.com.access.log;
    error_log /var/log/nginx/admin.example.com.error.log;

    # All admin endpoints require authentication
    location / {
        auth_request /authz;

        # Extract and pass client info
        auth_request_set $auth_client_id $upstream_http_x_auth_client_id;
        auth_request_set $auth_client_name $upstream_http_x_auth_client_name;

        proxy_pass http://backend_api;
        proxy_set_header Host $host;
        proxy_set_header X-Client-ID $auth_client_id;
        proxy_set_header X-Client-Name $auth_client_name;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Same internal auth endpoint
    location = /authz {
        internal;
        proxy_pass http://auth_service/authz;
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header X-Original-Host $host;  # admin.example.com
        proxy_set_header Authorization $http_authorization;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }
}
